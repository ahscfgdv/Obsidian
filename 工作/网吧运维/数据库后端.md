
---

## 1. 核心技术栈

- **ORM**: SQLAlchemy 2.0+ (声明式基类 `DeclarativeBase`)

- **迁移工具**: Alembic

- **数据库驱动**: 依赖于 `app.core.config.DATABASE_URL` 配置 (支持 PostgreSQL/MySQL/SQLite 等)

## 2. 目录结构

- `app/db/base_class.py`: 定义 ORM 基类 `Base`。

- `app/db/base.py`: 统一导入所有模型，方便 Alembic 识别。

- `app/db/session.py`: 数据库引擎创建与会话工厂配置。

- `app/models/`: 具体的数据库表模型定义。

- `alembic/`: 数据库迁移脚本与环境配置。
## 3. 会话管理 (Session Management)

系统使用 `sessionmaker` 创建同步会话工厂 `SessionLocal`，并通过 FastAPI 的依赖注入系统管理连接生命周期。

### 依赖注入函数: `get_db`

位于 `app/db/session.py`：

- **逻辑**: 为每个请求创建一个新的 `SessionLocal` 实例。

- **生命周期**: 请求开始时打开连接，请求结束（无论成功或异常）后通过 `finally` 块自动关闭。


```python

def get_db():

    db = SessionLocal()

    try:

        yield db

    finally:

        db.close()

```

## 4. 模型定义 (Models)

所有模型必须继承自 `app.db.base_class.Base`。

为了确保 Alembic 的 `autogenerate` 功能正常工作，新创建的模型需要在 `app/db/base.py` 中导入。


**当前已注册模型**:

- `User` (`sys_admin` 表)

- `Ticket` (`tickets` 表)
  

## 5. 数据库迁移 (Migrations)

系统使用 Alembic 处理数据库模式变更。
### 配置文件

- `alembic.ini`: 基础配置文件（包含数据库连接字符串引用）。

- `alembic/env.py`: 迁移执行环境，配置了 `target_metadata = Base.metadata` 以实现自动生成脚本。
### 常用命令

在 `server` 目录下执行：

- **创建迁移脚本**: `uv run alembic revision --autogenerate -m "描述"`

- **执行迁移**: `uv run alembic upgrade head`

- **回滚迁移**: `uv run alembic downgrade -1`
## 6. 配置项

数据库连接受 `server/app/core/config.py` 中的以下变量控制：

- `DATABASE_URL`: 完整数据库连接 URI。