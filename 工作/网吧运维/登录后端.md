这份关于 **FastAPI 用户认证与授权系统** 的技术文档已经过重新排版。我优化了结构层级，增强了代码与逻辑的可读性，并使其更符合开发文档的标准规范。

---

# FastAPI 用户认证系统技术文档

本系统基于 **FastAPI** 框架，实现了高性能、高安全性的用户登录与鉴权流程。支持标准 OAuth2 表单与现代前端常用的 JSON 提交方式。

---

## 🛠 1. 核心技术栈

- **Web 框架**: `FastAPI` (异步高性能框架)
    
- **持久层**: `PostgreSQL` / `MySQL` (使用 `SQLAlchemy` ORM)
    
- **安全加固**:
    
    - `JWT (JSON Web Tokens)`: 用于无状态身份验证。
        
    - `Bcrypt`: 专业的密码哈希加解密算法。
        
- **依赖管理**: `FastAPI Depends` (声明式依赖注入系统)。
    

---

## 🗄 2. 用户数据模型 (Data Model)

用户信息存储于系统管理表 `sys_admin` 中。

**文件路径**: `server/app/models/user.py`

|**字段名**|**类型**|**约束**|**说明**|
|---|---|---|---|
|**id**|Integer|Primary Key|唯一自增主键|
|**username**|String|Unique, Index|登录唯一用户名|
|**hashed_password**|String|Not Null|存储 Bcrypt 加密后的哈希值（严禁明文）|
|**is_active**|Boolean|Default: True|账户是否激活/可用|

---

## 🔐 3. 身份验证流程实现

认证接口位于 `server/app/api/v1/auth.py`，提供两种端点以适配不同场景：

### A. 开发者调试端点 (`/login`)

- **用途**: 兼容 FastAPI 自动生成的 **Swagger UI (OpenAPI)** 调试。
    
- **输入**: `OAuth2PasswordRequestForm` (表单格式)。
    
- **返回**: 标准 OAuth2 格式 Token。
    

### B. 生产环境端点 (`/login/json`)

- **用途**: 适配 Vue/React 等前端通过 `application/json` 提交的登录请求。
    
- **逻辑流**:
    
    1. **查询**: 根据 `username` 从数据库检索记录。
        
    2. **验证**: 使用 `bcrypt` 校验明文密码与哈希值。
        
    3. **签发**: 验证通过后，将用户 ID (`sub`) 写入 JWT Payload，设置过期时间。
        
    4. **响应**: 返回统一封装的 `success` 响应。
        

---

## 🛡 4. 安全底层机制

核心底层实现位于 `server/app/core/security.py`。

- **密码安全**:
    
    - 使用 `bcrypt.hashpw` 自动生成盐值并哈希。
        
    - 使用 `bcrypt.checkpw` 验证，可有效防御**定时攻击**。
        
- **JWT 规范**:
    
    - 使用 `python-jose` 库处理签名。
        
    - **Payload 结构**: `{ "sub": "user_id", "exp": 1712345678 }`。
        
    - **算法**: `HS256` 对称加密。
        

---

## 🚥 5. 鉴权依赖 (Dependency Injection)

系统通过 `get_current_user` 依赖项实现接口级准入控制。

**实现路径**: `server/app/api/deps.py`

1. **提取**: 从 Header 的 `Authorization: Bearer <token>` 获取令牌。
    
2. **校验**: 检查令牌签名合法性及是否过期。
    
3. **注入**: 自动查询数据库并将 `User` 对象注入到后续业务函数中。
    

**代码示例**:

Python

```
@router.get("/me", summary="获取当前登录用户信息")
def get_me(current_user: User = Depends(get_current_user)):
    """
    此接口受到 get_current_user 保护，
    未携带合法 Token 的请求将直接返回 401。
    """
    return success(data=current_user)
```

---

## ⚙️ 6. 系统环境配置

安全相关配置位于 `.env` 或 `server/app/core/config.py` 中。

> [!WARNING]
> 
> **SECRET_KEY** 是系统安全的命脉。在生产环境中必须使用高强度随机字符串，且严禁泄露。

- `SECRET_KEY`: JWT 签名密钥。
    
- `ALGORITHM`: 默认使用 `HS256`。
    
- `ACCESS_TOKEN_EXPIRE_MINUTES`: Token 有效期（建议设置为 30-60 分钟）。
    

---

**下一步建议：**

如果你需要，我可以为你生成一份配套的 **Vue3 + Axios** 登录前端代码实现，或者是完善 `get_current_user` 的详细代码逻辑。需要我这样做吗？