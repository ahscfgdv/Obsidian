这份文档总结了如何利用 **Croc** 的中继模式（Relay），配合公网 IP 和端口映射，实现跨网段的**满速文件传输**。

---

# 🚀 Croc 自建中继高速传输操作指南

## 1. 场景与原理

- **场景**：你需要将“内网电脑 A”的文件，高速发送给“公网路由下的电脑 B”。
    
- **痛点**：默认模式走国外公共服务器，速度慢且不稳定。
    
- **原理**：利用电脑 B 的公网环境自建中继，使数据通过 `公网 IP -> 路由器 -> 电脑 B` 直连，跑满物理带宽。
    

## 2. 前置准备

- **发送端（内网）**：已安装 Croc，文件所在电脑。
    
- **接收端（公网）**：已安装 Croc，连接在有公网 IP 的路由器下。
    
- **路由器权限**：需要进入接收端路由器的后台设置端口映射。
    

---

## 3. 核心步骤（一次性配置）

### 第一步：接收端网络配置（最关键）

在接收端（电脑 B）所在的路由器和系统中进行设置。

1. **路由器端口映射（Port Forwarding）**
    
    - 进入路由器后台，找到“虚拟服务器”或“端口转发”。
        
    - **规则**：将 **TCP 协议** 的 **9009 至 9013** 端口（共5个），全部映射到 **接收端电脑的内网 IP**（如 `192.168.1.x`）。
        
    - _注意：必须映射 9009-9013 全段，否则会报 `connection refused` 错误。_
        
2. **Windows 防火墙放行**
    
    - 在接收端电脑上，确保防火墙允许 `croc.exe` 通信。
        
    - 简单测试法：若连接失败，可暂时关闭“公用网络”防火墙进行排查。
        

---

## 4. 传输操作流程（每次传输时使用）

### 🖥️ 接收端（作为中继服务器 + 接收者）

你需要在这台电脑上打开**两个**终端窗口（CMD 或 PowerShell）。

**窗口 A：启动中继服务**

运行以下命令，启动服务并保持窗口开启（不要关闭）：

PowerShell

```
croc relay
```

> _成功标志：显示 `listening on :9009`_

**窗口 B：准备接收文件**

待发送端生成代码后，运行以下命令（**注意使用 127.0.0.1**）：

PowerShell

```
croc --relay 127.0.0.1:9009 [发送端生成的代码]
```

> _解释：使用 `127.0.0.1` 强制走本地回环，避免路由器 NAT Loopback 问题导致的 `room not ready` 错误。_

---

### 💻 发送端（内网电脑）

在文件所在的电脑上操作。

**窗口：发送文件**

运行以下命令，指定连接接收端的公网 IP：

PowerShell

```
croc --relay [接收端公网IP]:9009 send [文件路径]
```

_示例：_

PowerShell

```
croc --relay 27.185.79.10:9009 send D:\Project\dist.zip
```

> _成功标志：屏幕显示 Code（如 `1234-abcd`），将其复制给接收端窗口 B 使用。_

---

## 5. 常见错误排查 (Troubleshooting)

|**错误信息**|**原因分析**|**解决方案**|
|---|---|---|
|**connection refused (dial tcp ...:9010)**|路由器只映射了 9009，未映射数据端口 9010-9013。|去路由器后台补充映射 **9010, 9011, 9012, 9013** 端口。|
|**room not ready / maybe peer disconnected**|1. 发送端超时断开。<br><br>  <br><br>2. 接收端用了公网 IP 连自己（被路由器拦截）。|1. **重启发送端**生成新 Code。<br><br>  <br><br>2. 接收端命令必须用 **`--relay 127.0.0.1:9009`**。|
|**could not secure channel**|同上，通常是接收端连公网 IP 导致的握手失败。|改用 `127.0.0.1` 接收即可解决。|
|**wsasend: connection forcibly closed**|传输中途断网或防火墙拦截。|检查两端网络稳定性；检查 Windows 防火墙是否拦截了长连接。|

---

## 6. 极简速查表（复制用）

- **接收端 (窗口1 - 启动服务):**
    
    `croc relay`
    
- **发送端 (发文件):**
    
    `croc --relay [公网IP]:9009 send [文件路径]`
    
- **接收端 (窗口2 - 收文件):**
    
    `croc --relay 127.0.0.1:9009 [代码]`